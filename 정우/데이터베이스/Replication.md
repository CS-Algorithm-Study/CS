# 📲 DB Replication
## 목차
### 1. DB Replication란?
### 2. Replication 동작 방식
### 3. 복제 동기화 방식
</br>

## 🤔 DB Replication란?

![image](https://github.com/CS-Algorithm-Study/CS/assets/81271328/2dbb8bdb-7c28-4bc8-842f-fd91a70a7962)

- **Replication란 한 서버에서 다른 서버로 데이터를 동기화(복제) 하는 것을 말한다**
- **원본 데이터**를 가진 서버를 **소스 서버**
- **복제된 데이터**를 가지는 서버를 **레플리카 서버**

</br>
  
### Replication을 사용하는 이유


- **스케일 아웃**
  - 하나의 서버에서 처리하던 쿼리를 여러 대의 서버에서 처리함으로써 갑자기 늘어나는 트래픽을 대응하는 데 유연하다
- **데이터 백업**
  - 레플리카를 통해 백업을 할 수 있다
- **데이터 분석**
  - 데이터 분석의 경우 대량의 데이터를 조회하는 경우가 많고 쿼리 자체가 무거운 경우가 많은데 이를 레플리카 서버를 통해 할 수 있다
- **데이터의 지리적 분산**
  - 데이터베이스와 애플리케이션 서버와 가깝게 구성함으로써 응답속도를 개선할 수 있다


</br>

## 🤔 Replication 동작 방식


### 바이너리 로그

**데이터베이스 서버에서 발생하는 모든 변경사항을 별도의 로그 파일에 순서대로 저장**
- 데이터의 변경내역
- 데이터베이스나 테이블의 구조 변경
- 계정이나 권한의 변경정보
- **포맷**
  - **Statement 방식**
    - SQL 쿼리문 자체를 바이너리 코드로 저장하는 방식
    - SQL 쿼리를 손쉽게 확인할 수 있다는 장점이 있음
    - 비확정적인 쿼리(ex. delete/update 에 order by 없이 limit 사용 등) 가 실행된 경우 소스 서버와 레플리카 서버의 데이터가 다를 수 있음 
  - **Row 방식**
    - 변경된 데이터 자체를 모두 저장하는 방식
    - 소스 서버와 레플리카 서버의 데이터를 일관되게 할 수 있다는 장점이 있음
    - 많은 데이터를 변경하게 되면 전부 기록되므로 바이너리 로그 파일이 매우 커질 수 있음
  - **Mixed 방식**
    - 비확정적 쿼리는 Row 방식으로 저장하고, 이외에 쿼리는 Statement 방식으로 저장하는 방식

</br>

![image](https://github.com/CS-Algorithm-Study/CS/assets/81271328/1fca9dc3-18d6-4779-8cc0-eaf17c6aa298)

- Replication은 세개의 스레드를 통해 동작한다
- **Binary Log Dump Thread**
- - 바이너리 로그를 레플리카 서버로 전송하는 역할
  - Binary Log Dump Thread는 소스 서버에 존재하고, 레플리카 서버가 소스 서버에 연결되면 소스서버에서 내부적으로 생성된다
- **Replication I/O Thread**
  - 바이너리 로그 이벤트를 가져와 로컬 서버의 파일(Relay Log)로 저장하는 역할
- **Replication SQL Thread**
  - Relay log 파일의 이벤트들을 읽고 Replication을 실행

## 🤔 복제 동기화 방식

- **비동기 복제**
- 
![image](https://github.com/CS-Algorithm-Study/CS/assets/81271328/a4892381-95fe-4456-a93f-0ce5e0ed76e2)

- 소스 서버가 레플리카 서버에서 변경 이벤트가 정상적으로 전달됐는지 확인하지 않는다
- 확인하는 과정이 없기 때문에 빠르지만 소스 서버와 레플리카 서버의 데이터가 다를 수 있음

</br>

- **반동기 복제**

![image](https://github.com/CS-Algorithm-Study/CS/assets/81271328/daef6c1c-13de-4b84-9748-78c9d3d41f8c)

- 레플리카 서버가 소스 서버로부터 전달 받은 변경 이벤트를 릴레이 로그에 기록 후 응답을 보내면 그때 트랜잭션을 완전히 커밋한다
- 트랜잭션의 전송은 보장하지만 레플리카 서버의 실제 적용이 보장되진 않음
- 반동기 복제에서 응답이 없으면 비동기 복제 방식으로 전환됨
